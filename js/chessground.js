!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Chessground=t()}(this,function(){"use strict";const e=["white","black"],t=["a","b","c","d","e","f","g","h"],o=["1","2","3","4","5","6","7","8"],n=[...o].reverse(),r=t.flatMap(e=>o.map(t=>e+t)),s=e=>r[8*e[0]+e[1]],i=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],c=r.map(i);const a=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},l=e=>"white"===e?"black":"white",d=(e,t)=>(e[0]-t[0])**2+(e[1]-t[1])**2,u=(e,t)=>e.role===t.role&&e.color===t.color,p=e=>(t,o)=>[(o?t[0]:7-t[0])*e.width/8,(o?7-t[1]:t[1])*e.height/8],h=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},f=(e,t,o=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${o})`},g=(e,t)=>{e.style.visibility=t?"visible":"hidden"},m=e=>e.clientX||0===e.clientX?[e.clientX,e.clientY]:e.targetTouches?.[0]?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0,b=e=>2===e.button,v=(e,t)=>{const o=document.createElement(e);return t&&(o.className=t),o};function w(e,t,o){const n=i(e);return t||(n[0]=7-n[0],n[1]=7-n[1]),[o.left+o.width*n[0]/8+o.width/16,o.top+o.height*(7-n[1])/8+o.height/16]}const y=(e,t)=>Math.abs(e-t),k=(e,t,o,n)=>y(e,o)*y(t,n)===2,C=(e,t,o,n)=>e===o!=(t===n),M=(e,t,o,n)=>y(e,o)===y(t,n)&&e!==o,P=(e,t,o,n)=>C(e,t,o,n)||M(e,t,o,n),x=(e,t,o,n)=>1===Math.max(y(e,o),y(t,n)),S=(e,t,o,n,r)=>1===y(e,o)&&n===t+(r?1:-1),A=(e,t,o,n,r)=>{const s=r?1:-1;return e===o&&(n===t+s||n===t+2*s&&(r?t<=1:t>=6))},K=(e,t,o,n)=>{const r=o-e,i=n-t;if(r&&i&&Math.abs(r)!==Math.abs(i))return[];const c=Math.sign(r),a=Math.sign(i),l=[];let d=e+c,u=t+a;for(;d!==o||u!==n;)l.push([d,u]),d+=c,u+=a;return l.map(e=>s(e))},O=e=>{const t=i(e),o=[];return t[0]>0&&o.push([t[0]-1,t[1]]),t[0]<7&&o.push([t[0]+1,t[1]]),o.map(s)},q=(e,t)=>{const o=i(e);return o[1]+=t,s(o)},T=e=>e.friendlies.has(s(e.pos2)),$=(e,t,o)=>K(...e,...t).some(e=>o.has(e)),E=(e,t,o)=>{const n=o.enemies.get(e);if("pawn"!==n?.role)return!1;const r="white"===n.color?1:-1,s=i(e),c=i(t);return A(...s,...c,"white"===n.color)&&!$(s,[c[0],c[1]+r],o.allPieces)},D=(e,t)=>{const o=e.pos2;return[...e.enemies].some(([n,r])=>{const s=i(n);return!t?.includes(r.role)&&("pawn"===r.role&&S(...s,...o,"white"===r.color)||"knight"===r.role&&k(...s,...o)||"bishop"===r.role&&M(...s,...o)||"rook"===r.role&&C(...s,...o)||"queen"===r.role&&P(...s,...o)||"king"===r.role&&x(...s,...o))&&(!["bishop","rook","queen"].includes(r.role)||!$(s,o,e.allPieces))})},L=e=>T(e)&&(W(s(e.pos2),e.friendlies,e.enemies,e.lastMove)||D(e)),W=(e,t,o,n)=>{if(n&&e!==n[1])return!1;const r=i(e),c=t.get(e);return"pawn"===c?.role&&r[1]===("white"===c.color?3:4)&&(!n||2===y(i(n[0])[1],r[1]))&&[1,-1].some(e=>"pawn"===o.get(s([r[0]+e,r[1]]))?.role)},F=e=>{if(e.unrestrictedPremoves)return!0;const t=K(...e.pos1,...e.pos2),o=t.filter(t=>e.enemies.has(t));if(o.length>1)return!1;if(!o.length)return!0;const n=o[0],r=e.enemies.get(n);if(!r||"pawn"!==r.role)return!0;const c="white"===r.color?1:-1,a=q(n,c),l=[...O(a).filter(t=>((e,t,o)=>{const n=o.enemies.get(e);return"pawn"===n?.role&&S(...i(e),...i(t),"white"===n.color)&&(o.friendlies.has(t)||W(q(t,"white"===n.color?-1:1),o.friendlies,o.enemies,o.lastMove))})(n,t,e)),...[a,q(a,c)].filter(t=>t&&E(n,t,e))],d=[...t,s(e.pos1)];return l.some(e=>!d.includes(e))},H=e=>(e=>{if(e.unrestrictedPremoves)return!0;const t=K(...e.pos1,...e.pos2),o=t.filter(t=>e.friendlies.has(t));return!o.length||1===o.length&&W(o[0],e.friendlies,e.enemies,e.lastMove)&&!t.includes(q(o[0],"white"===e.color?-1:1))})(e)&&F(e),N=e=>M(...e.pos1,...e.pos2)&&H(e)&&(e.unrestrictedPremoves||!T(e)||L(e)),B=e=>C(...e.pos1,...e.pos2)&&H(e)&&(e.unrestrictedPremoves||!T(e)||L(e)),j={pawn:e=>{const t="white"===e.color?1:-1;return!(y(e.pos1[0],e.pos2[0])>1)&&(y(e.pos1[0],e.pos2[0])?e.pos2[1]===e.pos1[1]+t&&(!(!e.unrestrictedPremoves&&!(e=>e.enemies.has(s(e.pos2)))(e))||(T(e)?D(e):(e=>[...e.enemies.keys()].some(t=>E(t,s(e.pos2),e)))(e)||W(s([e.pos2[0],e.pos2[1]+t]),e.friendlies,e.enemies,e.lastMove)||D(e,["pawn"]))):A(...e.pos1,...e.pos2,"white"===e.color)&&H({...e,pos2:[e.pos2[0],e.pos2[1]+t]}))},knight:e=>k(...e.pos1,...e.pos2)&&(e.unrestrictedPremoves||!T(e)||L(e)),bishop:N,rook:B,queen:e=>N(e)||B(e),king:e=>x(...e.pos1,...e.pos2)&&(e.unrestrictedPremoves||!T(e)||L(e))||e.canCastle&&e.pos1[1]===e.pos2[1]&&e.pos1[1]===("white"===e.color?0:7)&&(4===e.pos1[0]&&(2===e.pos2[0]&&e.rookFilesFriendlies.includes(0)||6===e.pos2[0]&&e.rookFilesFriendlies.includes(7))||e.rookFilesFriendlies.includes(e.pos2[0]))&&(e.unrestrictedPremoves||K(...e.pos1,e.pos2[0]>e.pos1[0]?7:1,e.pos2[1]).map(t=>e.allPieces.get(t)).every(t=>!t||u(t,{role:"rook",color:e.color})))};function R(e,t){const o=e.pieces,n=e.premovable.castle,r=!!e.premovable.unrestrictedPremoves,a=o.get(t);if(!a||a.color===e.turnColor)return[];const d=a.color,u=new Map([...o].filter(([e,t])=>t.color===d)),p=new Map([...o].filter(([e,t])=>t.color===l(d))),h=i(t),f=j[a.role],g={pos1:h,allPieces:o,friendlies:u,enemies:p,unrestrictedPremoves:r,color:d,canCastle:n,rookFilesFriendlies:Array.from(o).filter(([e,t])=>e[1]===("white"===d?"1":"8")&&t.color===d&&"rook"===t.role).map(([e])=>i(e)[0]),lastMove:e.lastMove};return c.filter(e=>f({...g,pos2:e})).map(s)}function z(e,...t){e&&setTimeout(()=>e(...t),1)}function I(e){e.premovable.current&&(e.premovable.current=void 0,z(e.premovable.events.unset))}function V(e){const t=e.predroppable;t.current&&(t.current=void 0,z(t.events.unset))}function G(e,t,o){const n=e.pieces.get(t),r=e.pieces.get(o);if(t===o||!n)return!1;const c=r&&r.color!==n.color?r:void 0;return o===e.selected&&J(e),z(e.events.move,t,o,c),function(e,t,o){if(!e.autoCastle)return!1;const n=e.pieces.get(t);if(!n||"king"!==n.role)return!1;const r=i(t),c=i(o);if(0!==r[1]&&7!==r[1]||r[1]!==c[1])return!1;4!==r[0]||e.pieces.has(o)||(6===c[0]?o=s([7,c[1]]):2===c[0]&&(o=s([0,c[1]])));const a=e.pieces.get(o);return!(!a||a.color!==n.color||"rook"!==a.role||(e.pieces.delete(t),e.pieces.delete(o),r[0]<c[0]?(e.pieces.set(s([6,c[1]]),n),e.pieces.set(s([5,c[1]]),a)):(e.pieces.set(s([2,c[1]]),n),e.pieces.set(s([3,c[1]]),a)),0))}(e,t,o)||(e.pieces.set(o,n),e.pieces.delete(t)),e.lastMove=[t,o],e.check=void 0,z(e.events.change),c||!0}function X(e,t,o,n){if(e.pieces.has(o)){if(!n)return!1;e.pieces.delete(o)}return z(e.events.dropNewPiece,t,o),e.pieces.set(o,t),e.lastMove=[o],e.check=void 0,z(e.events.change),e.movable.dests=void 0,e.turnColor=l(e.turnColor),!0}function Z(e,t,o){const n=G(e,t,o);return n&&(e.movable.dests=void 0,e.turnColor=l(e.turnColor),e.animation.current=void 0),n}function Y(e,t,o){if(te(e,t,o)){const n=Z(e,t,o);if(n){const r=e.hold.stop();J(e);const s={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return!0!==n&&(s.captured=n),z(e.movable.events.after,t,o,s),!0}}else if(ne(e,t,o))return function(e,t,o,n){V(e),e.premovable.current=[t,o],z(e.premovable.events.set,t,o,n)}(e,t,o,{ctrlKey:e.stats.ctrlKey}),J(e),!0;return J(e),!1}function _(e,t,o,n){const r=e.pieces.get(t);r&&(function(e,t,o){const n=e.pieces.get(t);return!(!n||t!==o&&e.pieces.has(o)||"both"!==e.movable.color&&(e.movable.color!==n.color||e.turnColor!==n.color))}(e,t,o)||n)?(e.pieces.delete(t),X(e,r,o,n),z(e.movable.events.afterNewPiece,r.role,o,{premove:!1,predrop:!1})):r&&function(e,t,o){const n=e.pieces.get(t),r=e.pieces.get(o);return!!n&&(!r||r.color!==e.movable.color)&&e.predroppable.enabled&&("pawn"!==n.role||"1"!==o[1]&&"8"!==o[1])&&e.movable.color===n.color&&e.turnColor!==n.color}(e,t,o)?function(e,t,o){I(e),e.predroppable.current={role:t,key:o},z(e.predroppable.events.set,t,o)}(e,r.role,o):(I(e),V(e)),e.pieces.delete(t),J(e)}function Q(e,t,o){if(z(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled)return J(e),void e.hold.cancel();if((e.selectable.enabled||o)&&e.selected!==t&&Y(e,e.selected,t))return void(e.stats.dragged=!1)}(e.selectable.enabled||e.draggable.enabled)&&(ee(e,t)||oe(e,t))&&(U(e,t),e.hold.start())}function U(e,t){e.selected=t,oe(e,t)?e.premovable.customDests||(e.premovable.dests=R(e,t)):e.premovable.dests=void 0}function J(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function ee(e,t){const o=e.pieces.get(t);return!!o&&("both"===e.movable.color||e.movable.color===o.color&&e.turnColor===o.color)}const te=(e,t,o)=>t!==o&&ee(e,t)&&(e.movable.free||!!e.movable.dests?.get(t)?.includes(o));function oe(e,t){const o=e.pieces.get(t);return!!o&&e.premovable.enabled&&e.movable.color===o.color&&e.turnColor!==o.color}const ne=(e,t,o)=>t!==o&&oe(e,t)&&(e.premovable.customDests?.get(t)??R(e,t)).includes(o);function re(e){const t=e.premovable.current;if(!t)return!1;const o=t[0],n=t[1];let r=!1;if(te(e,o,n)){const t=Z(e,o,n);if(t){const s={premove:!0};!0!==t&&(s.captured=t),z(e.movable.events.after,o,n,s),r=!0}}return I(e),r}function se(e){I(e),V(e),J(e)}function ie(e){e.movable.color=e.movable.dests=e.animation.current=void 0,se(e)}function ce(e,t,o){let n=Math.floor(8*(e[0]-o.left)/o.width);t||(n=7-n);let r=7-Math.floor(8*(e[1]-o.top)/o.height);return t||(r=7-r),n>=0&&n<8&&r>=0&&r<8?s([n,r]):void 0}const ae=e=>"white"===e.orientation,le="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",de={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},ue={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function pe(e){"start"===e&&(e=le);const t=new Map;let o=7,n=0;for(const r of e)switch(r){case" ":case"[":return t;case"/":if(--o,o<0)return t;n=0;break;case"~":{const e=t.get(s([n-1,o]));e&&(e.promoted=!0);break}default:{const e=r.charCodeAt(0);if(e<57)n+=e-48;else{const e=r.toLowerCase(),i=s([n,o]);i&&t.set(i,{role:de[e],color:r===e?"black":"white"}),++n}}}return t}function he(e,t){t.animation&&(ge(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function fe(e,t){if(t.movable?.dests&&(e.movable.dests=void 0),t.drawable?.autoShapes&&(e.drawable.autoShapes=[]),ge(e,t),t.fen&&(e.pieces=pe(t.fen),e.drawable.shapes=t.drawable?.shapes||[]),"check"in t&&function(e,t){if(e.check=void 0,!0===t&&(t=e.turnColor),t)for(const[o,n]of e.pieces)"king"===n.role&&n.color===t&&(e.check=o)}(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&U(e,e.selected),he(e,t),!e.movable.rookCastle&&e.movable.dests){const t="white"===e.movable.color?"1":"8",o="e"+t,n=e.movable.dests.get(o),r=e.pieces.get(o);if(!n||!r||"king"!==r.role)return;e.movable.dests.set(o,n.filter(e=>!(e==="a"+t&&n.includes("c"+t)||e==="h"+t&&n.includes("g"+t))))}}function ge(e,t){for(const o in t)"__proto__"!==o&&"constructor"!==o&&Object.prototype.hasOwnProperty.call(t,o)&&(Object.prototype.hasOwnProperty.call(e,o)&&me(e[o])&&me(t[o])?ge(e[o],t[o]):e[o]=t[o])}function me(e){if("object"!=typeof e||null===e)return!1;const t=Object.getPrototypeOf(e);return t===Object.prototype||null===t}const be=(e,t)=>t.animation.enabled?function(e,t){const o=new Map(t.pieces),n=e(t),s=function(e,t){const o=new Map,n=[],s=new Map,i=[],c=[],a=new Map;let l,d,p;for(const[t,o]of e)a.set(t,we(t,o));for(const e of r)l=t.pieces.get(e),d=a.get(e),l?d?u(l,d.piece)||(i.push(d),c.push(we(e,l))):c.push(we(e,l)):d&&i.push(d);for(const e of c)d=ye(e,i.filter(t=>u(e.piece,t.piece))),d&&(p=[d.pos[0]-e.pos[0],d.pos[1]-e.pos[1]],o.set(e.key,p.concat(p)),n.push(d.key));for(const e of i)n.includes(e.key)||s.set(e.key,e.piece);return{anims:o,fadings:s}}(o,t);if(s.anims.size||s.fadings.size){const e=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:s},e||ke(t,performance.now())}else t.dom.redraw();return n}(e,t):ve(e,t);function ve(e,t){const o=e(t);return t.dom.redraw(),o}const we=(e,t)=>({key:e,pos:i(e),piece:t}),ye=(e,t)=>t.sort((t,o)=>d(e.pos,t.pos)-d(e.pos,o.pos))[0];function ke(e,t){const o=e.animation.current;if(void 0===o)return void(e.dom.destroyed||e.dom.redrawNow());const n=1-(t-o.start)*o.frequency;if(n<=0)e.animation.current=void 0,e.dom.redrawNow();else{const t=Ce(n);for(const e of o.plan.anims.values())e[2]=e[0]*t,e[3]=e[1]*t;e.dom.redrawNow(!0),requestAnimationFrame((t=performance.now())=>ke(e,t))}}const Ce=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,Me=["green","red","blue","yellow"];function Pe(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?J(e):se(e);const o=m(t),n=ce(o,ae(e),e.dom.bounds());n&&(e.drawable.current={orig:n,pos:o,brush:Oe(t),snapToValidMove:e.drawable.defaultSnapToValidMove},xe(e))}function xe(e){requestAnimationFrame(()=>{const t=e.drawable.current;if(t){const o=ce(t.pos,ae(e),e.dom.bounds());o||(t.snapToValidMove=!1);const n=t.snapToValidMove?function(e,t,o,n){const r=i(e),a=c.filter(e=>{return o=e,(t=r)[0]===o[0]&&t[1]===o[1]||P(r[0],r[1],e[0],e[1])||k(r[0],r[1],e[0],e[1]);var t,o}),l=a.map(e=>w(s(e),o,n)).map(e=>d(t,e)),[,u]=l.reduce((e,t,o)=>e[0]<t?e:[t,o],[l[0],0]);return s(a[u])}(t.orig,t.pos,ae(e),e.dom.bounds()):o;n!==t.mouseSq&&(t.mouseSq=n,t.dest=n!==t.orig?n:void 0,e.dom.redrawNow()),xe(e)}})}function Se(e,t){e.drawable.current&&(e.drawable.current.pos=m(t))}function Ae(e){const t=e.drawable.current;t&&(t.mouseSq&&function(e,t){const o=e=>e.orig===t.orig&&e.dest===t.dest,n=e.shapes.find(o);n&&(e.shapes=e.shapes.filter(e=>!o(e)));n&&n.brush===t.brush||e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush});qe(e)}(e.drawable,t),Ke(e))}function Ke(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Oe(e){const t=(e.shiftKey||e.ctrlKey)&&b(e),o=e.altKey||e.metaKey||e.getModifierState?.("AltGraph");return Me[(t?1:0)+(o?2:0)]}function qe(e){e.onChange&&e.onChange(e.shapes)}function Te(e,t){if(!e.trustAllEvents&&!t.isTrusted)return;if(void 0!==t.buttons&&t.buttons>1)return;if(t.touches&&t.touches.length>1)return;const o=e.dom.bounds(),n=m(t),r=ce(n,ae(e),o);if(!r)return;const s=e.pieces.get(r),c=e.selected;var a;if(c||!e.drawable.enabled||!e.drawable.eraseOnClick&&s&&s.color===e.turnColor||(a=e).drawable.shapes.length&&(a.drawable.shapes=[],a.dom.redraw(),qe(a.drawable)),!1!==t.cancelable&&(!t.touches||e.blockTouchScroll||s||c||function(e,t){const o=ae(e),n=e.dom.bounds(),r=2*Math.pow(e.touchIgnoreRadius*n.width/16,2);for(const s of e.pieces.keys()){const e=w(s,o,n);if(d(e,t)<=r)return!0}return!1}(e,n)))t.preventDefault();else if(t.touches)return;const l=!!e.premovable.current,u=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&te(e,e.selected,r)?be(e=>Q(e,r),e):Q(e,r);const f=e.selected===r,b=Fe(e,r);if(s&&b&&f&&function(e,t){const o=e.pieces.get(t);return!!o&&e.draggable.enabled&&("both"===e.movable.color||e.movable.color===o.color&&(e.turnColor===o.color||e.premovable.enabled))}(e,r)){e.draggable.current={orig:r,piece:s,origPos:n,pos:n,started:e.draggable.autoDistance&&e.stats.dragged,element:b,previouslySelected:c,originTarget:t.target,keyHasChanged:!1},b.cgDragging=!0,b.classList.add("dragging");const a=e.dom.elements.ghost;a&&(a.className=`ghost ${s.color} ${s.role}`,h(a,p(o)(i(r),ae(e))),g(a,!0)),$e(e)}else l&&I(e),u&&V(e);e.dom.redraw()}function $e(e){requestAnimationFrame(()=>{const t=e.draggable.current;if(!t)return;e.animation.current?.plan.anims.has(t.orig)&&(e.animation.current=void 0);const o=e.pieces.get(t.orig);if(o&&u(o,t.piece)){if(!t.started&&d(t.pos,t.origPos)>=Math.pow(e.draggable.distance,2)&&(t.started=!0),t.started){if("function"==typeof t.element){const e=t.element();if(!e)return;e.cgDragging=!0,e.classList.add("dragging"),t.element=e}const o=e.dom.bounds();h(t.element,[t.pos[0]-o.left-o.width/16,t.pos[1]-o.top-o.height/16]),t.keyHasChanged||(t.keyHasChanged=t.orig!==ce(t.pos,ae(e),o))}}else Le(e);$e(e)})}function Ee(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=m(t))}function De(e,t){const o=e.draggable.current;if(!o)return;if("touchend"===t.type&&!1!==t.cancelable&&t.preventDefault(),"touchend"===t.type&&o.originTarget!==t.target&&!o.newPiece)return void(e.draggable.current=void 0);I(e),V(e);const n=ce(m(t)||o.pos,ae(e),e.dom.bounds());n&&o.started&&o.orig!==n?o.newPiece?_(e,o.orig,n,o.force):(e.stats.ctrlKey=t.ctrlKey,Y(e,o.orig,n)&&(e.stats.dragged=!0)):o.newPiece?e.pieces.delete(o.orig):e.draggable.deleteOnDropOff&&!n&&(e.pieces.delete(o.orig),z(e.events.change)),(o.orig!==o.previouslySelected&&!o.keyHasChanged||o.orig!==n&&n)&&e.selectable.enabled||J(e),We(e),e.draggable.current=void 0,e.dom.redraw()}function Le(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,J(e),We(e),e.dom.redraw())}function We(e){const t=e.dom.elements;t.ghost&&g(t.ghost,!1)}function Fe(e,t){let o=e.dom.elements.board.firstChild;for(;o;){if(o.cgKey===t&&"PIECE"===o.tagName)return o;o=o.nextSibling}}function He(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function Ne(e,o){function r(){!function(e){e.orientation=l(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}(e),o()}return{set(t){t.orientation&&t.orientation!==e.orientation&&r(),he(e,t),(t.fen?be:ve)(e=>fe(e,t),e)},state:e,getFen:()=>{return o=e.pieces,n.map(e=>t.map(t=>{const n=o.get(t+e);if(n){let e=ue[n.role];return"white"===n.color&&(e=e.toUpperCase()),n.promoted&&(e+="~"),e}return"1"}).join("")).join("/").replace(/1{2,}/g,e=>e.length.toString());var o},toggleOrientation:r,setPieces(t){be(e=>function(e,t){for(const[o,n]of t)n?e.pieces.set(o,n):e.pieces.delete(o)}(e,t),e)},selectSquare(t,o){t?be(e=>Q(e,t,o),e):e.selected&&(J(e),e.dom.redraw())},move(t,o){be(e=>G(e,t,o),e)},newPiece(t,o){be(e=>X(e,t,o),e)},playPremove(){if(e.premovable.current){if(be(re,e))return!0;e.dom.redraw()}return!1},playPredrop(t){if(e.predroppable.current){const o=function(e,t){const o=e.predroppable.current;let n=!1;if(!o)return!1;t(o)&&X(e,{role:o.role,color:e.movable.color},o.key)&&(z(e.movable.events.afterNewPiece,o.role,o.key,{premove:!1,predrop:!0}),n=!0);return V(e),n}(e,t);return e.dom.redraw(),o}return!1},cancelPremove(){ve(I,e)},cancelPredrop(){ve(V,e)},cancelMove(){ve(e=>{se(e),Le(e)},e)},stop(){ve(e=>{ie(e),Le(e)},e)},explode(t){!function(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{He(e,2),setTimeout(()=>He(e,void 0),120)},120)}(e,t)},setAutoShapes(t){ve(e=>e.drawable.autoShapes=t,e)},setShapes(t){ve(e=>e.drawable.shapes=t.slice(),e)},getKeyAtDomPos:t=>ce(t,ae(e),e.dom.bounds()),redrawAll:o,dragNewPiece(t,o,n){!function(e,t,o,n){const r="a0";e.pieces.set(r,t),e.dom.redraw();const s=m(o);e.draggable.current={orig:r,piece:t,origPos:s,pos:s,started:!0,element:()=>Fe(e,r),originTarget:o.target,newPiece:!0,force:!!n,keyHasChanged:!1},$e(e)}(e,t,o,n)},destroy(){ie(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function Be(e,t){const o=e.drawable,n=o.current,r=n&&n.mouseSq?n:void 0,s=new Map,c=e.dom.bounds(),a=o.autoShapes.filter(e=>!e.piece);for(const t of o.shapes.concat(a).concat(r?[r]:[])){if(!t.dest)continue;const o=s.get(t.dest)??new Set,n=et(Ge(i(t.orig),e.orientation),c),r=et(Ge(i(t.dest),e.orientation),c);o.add(tt(n,r)),s.set(t.dest,o)}const l=[];for(const e of o.shapes.concat(a))l.push({shape:e,current:!1,hash:je(e,Xe(e.dest,s),!1,c)});r&&l.push({shape:r,current:!0,hash:je(r,Xe(r.dest,s),!0,c)});const d=l.map(e=>e.hash).join(";");d!==e.drawable.prevSvgHash&&(e.drawable.prevSvgHash=d,function(e,t,o){for(const n of[o.shapes,o.shapesBelow]){const r=n.querySelector("defs"),s=t.filter(e=>n===o.shapesBelow==!!e.shape.below),i=new Map;for(const t of s.filter(e=>e.shape.dest&&e.shape.brush)){const o=_e(e.brushes[t.shape.brush],t.shape.modifiers),{key:n,color:r}=Ue(t.shape);n&&r&&i.set(n,{key:n,color:r,opacity:1,lineWidth:1}),i.set(o.key,o)}const c=new Set;let a=r.firstElementChild;for(;a;)c.add(a.getAttribute("cgKey")),a=a.nextElementSibling;for(const[e,t]of i.entries())c.has(e)||r.appendChild(Ie(t))}}(o,l,t),function(e,t,o){for(const[n,r]of[[t.shapes,t.custom],[t.shapesBelow,t.customBelow]]){const[s,i]=[n,r].map(e=>e.querySelector("g")),c=e.filter(e=>n===t.shapesBelow==!!e.shape.below),a=new Map;for(const e of c)a.set(e.hash,!1);for(const e of[s,i]){const t=[];let o,n=e.firstElementChild;for(;n;)o=n.getAttribute("cgHash"),a.has(o)?a.set(o,!0):t.push(n),n=n.nextElementSibling;for(const o of t)e.removeChild(o)}for(const e of c.filter(e=>!a.get(e.hash)))for(const t of o(e))t.isCustom?i.appendChild(t.el):s.appendChild(t.el)}}(l,t,t=>function(e,{shape:t,current:o,hash:n},r,s,c){const a=et(Ge(i(t.orig),e.orientation),c),l=t.dest?et(Ge(i(t.dest),e.orientation),c):a,d=t.brush&&_e(r[t.brush],t.modifiers),u=s.get(t.dest),p=[];if(d){const e=Ye(Ze("g"),{cgHash:n});p.push({el:e}),a[0]!==l[0]||a[1]!==l[1]?e.appendChild(function(e,t,o,n,r,s){function i(i){const c=function(e){return(e?20:10)/64}(s&&!r),a=n[0]-o[0],l=n[1]-o[1],d=Math.atan2(l,a),u=Math.cos(d)*c,p=Math.sin(d)*c,h=Ue(e);return Ye(Ze("line"),{stroke:i?h.color:t.color,"stroke-width":Qe(t,r)*(i?1.14:1),"stroke-linecap":"round","marker-end":`url(#arrowhead-${i?h.key:t.key})`,opacity:e.modifiers?.hilite?1:Je(t,r),x1:o[0],y1:o[1],x2:n[0]-u,y2:n[1]-p})}if(!e.modifiers?.hilite)return i(!1);const c=Ye(Ze("g"),{opacity:t.opacity}),a=Ye(Ze("g"),{filter:"url(#cg-filter-blur)"});return a.appendChild(function(e,t){const o={from:[Math.floor(Math.min(e[0],t[0])),Math.floor(Math.min(e[1],t[1]))],to:[Math.ceil(Math.max(e[0],t[0])),Math.ceil(Math.max(e[1],t[1]))]};return Ye(Ze("rect"),{x:o.from[0],y:o.from[1],width:o.to[0]-o.from[0],height:o.to[1]-o.from[1],fill:"none",stroke:"none"})}(o,n)),a.appendChild(i(!0)),c.appendChild(a),c.appendChild(i(!1)),c}(t,d,a,l,o,Xe(t.dest,s))):e.appendChild(function(e,t,o,n){const r=[3/64,4/64],s=(n.width+n.height)/(4*Math.max(n.width,n.height));return Ye(Ze("circle"),{stroke:e.color,"stroke-width":r[o?0:1],fill:"none",opacity:Je(e,o),cx:t[0],cy:t[1],r:s-r[1]/2})}(r[t.brush],a,o,c))}if(t.label){const e=t.label;e.fill??(e.fill=t.brush&&r[t.brush].color);const o=t.brush?void 0:"tr";p.push({el:Ve(e,n,a,l,u,o),isCustom:!0})}if(t.customSvg){const e=t.customSvg.center??"orig",[o,r]="label"===e?ot(a,l,u).map(e=>e-.5):"dest"===e?l:a,s=Ye(Ze("g"),{transform:`translate(${o},${r})`,cgHash:n});s.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,p.push({el:s,isCustom:!0})}return p}(e,t,o.brushes,s,c)))}function je({orig:e,dest:t,brush:o,piece:n,modifiers:r,customSvg:s,label:i,below:c},a,l,d){return[d.width,d.height,l,e,t,o,a&&"-",n&&Re(n),r&&(u=r,[u.lineWidth,u.hilite].filter(e=>e).join(",")),s&&`custom-${ze(s.html)},${s.center?.[0]??"o"}`,i&&`label-${ze(i.text)}`,c&&"below"].filter(e=>e).join(",");var u}function Re(e){return[e.color,e.role,e.scale].filter(e=>e).join(",")}function ze(e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e.charCodeAt(o)>>>0;return t.toString()}function Ie(e){const t=Ye(Ze("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(Ye(Ze("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function Ve(e,t,o,n,r,s){const i=.4*.75**e.text.length,c=ot(o,n,r),a="tr"===s?.4:0,l=Ye(Ze("g"),{transform:`translate(${c[0]+a},${c[1]-a})`,cgHash:t});l.appendChild(Ye(Ze("circle"),{r:.2,"fill-opacity":s?1:.8,"stroke-opacity":s?1:.7,"stroke-width":.03,fill:e.fill??"#666",stroke:"white"}));const d=Ye(Ze("text"),{"font-size":i,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return d.innerHTML=e.text,l.appendChild(d),l}function Ge(e,t){return"white"===t?e:[7-e[0],7-e[1]]}function Xe(e,t){return!0===(e&&t.has(e)&&t.get(e).size>1)}function Ze(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function Ye(e,t){for(const o in t)Object.prototype.hasOwnProperty.call(t,o)&&e.setAttribute(o,t[o]);return e}function _e(e,t){return t?{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(e=>e).join("")}:e}function Qe(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function Ue(e){const t=e.modifiers?.hilite;return{key:t&&`hilite-${t.replace("#","")}`,color:t}}function Je(e,t){return(e.opacity||1)*(t?.9:1)}function et(e,t){const o=Math.min(1,t.width/t.height),n=Math.min(1,t.height/t.width);return[(e[0]-3.5)*o,(3.5-e[1])*n]}function tt(e,t,o=!0){const n=Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI;return o?(Math.round(8*n/Math.PI)+16)%16:n}function ot(e,t,o){let n=function(e,t){return Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((e,t)=>e+t*t,0))}(e,t);const r=tt(e,t,!1);if(o&&(n-=33/64,o.size>1)){n-=10/64;const r=tt(e,t);(o.has((r+1)%16)||o.has((r+15)%16))&&1&r&&(n-=.4)}return[e[0]-Math.cos(r)*n,e[1]-Math.sin(r)*n].map(e=>e+.5)}function nt(e,t){const o=Ye(Ze("svg"),{class:e,viewBox:t?"-4 -4 8 8":"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"});return t&&o.appendChild(function(){const e=Ze("defs"),t=Ye(Ze("filter"),{id:"cg-filter-blur"});return t.appendChild(Ye(Ze("feGaussianBlur"),{stdDeviation:"0.013"})),e.appendChild(t),e}()),o.appendChild(Ze("g")),o}function rt(e,t){const o=v("coords",t);let n;for(const t of e)n=v("coord"),n.textContent=t,o.appendChild(n);return o}function st(e,t,o,n){return e.addEventListener(t,o,n),()=>e.removeEventListener(t,o,n)}const it=e=>t=>{e.draggable.current?Le(e):e.drawable.current?Ke(e):t.shiftKey||b(t)?e.drawable.enabled&&Pe(e,t):e.viewOnly||(e.dropmode.active?function(e,t){if(!e.dropmode.active)return;I(e),V(e);const o=e.dropmode.piece;if(o){e.pieces.set("a0",o);const n=m(t),r=n&&ce(n,ae(e),e.dom.bounds());r&&_(e,"a0",r)}e.dom.redraw()}(e,t):Te(e,t))},ct=(e,t,o)=>n=>{e.drawable.current?e.drawable.enabled&&o(e,n):e.viewOnly||t(e,n)};function at(e){const t=ae(e),o=p(e.dom.bounds()),n=e.dom.elements.board,r=e.pieces,s=e.animation.current,c=s?s.plan.anims:new Map,a=s?s.plan.fadings:new Map,l=e.draggable.current,d=function(e){const t=new Map;if(e.lastMove&&e.highlight.lastMove)for(const o of e.lastMove)gt(t,o,"last-move");e.check&&e.highlight.check&&gt(t,e.check,"check");if(e.selected&&(gt(t,e.selected,"selected"),e.movable.showDests)){const o=e.movable.dests?.get(e.selected);if(o)for(const n of o)gt(t,n,"move-dest"+(e.pieces.has(n)?" oc":""));const n=e.premovable.customDests?.get(e.selected)??e.premovable.dests;if(n)for(const o of n)gt(t,o,"premove-dest"+(e.pieces.has(o)?" oc":""))}const o=e.premovable.current;if(o)for(const e of o)gt(t,e,"current-premove");else e.predroppable.current&&gt(t,e.predroppable.current.key,"current-premove");const n=e.exploding;if(n)for(const e of n.keys)gt(t,e,"exploding"+n.stage);e.highlight.custom&&e.highlight.custom.forEach((e,o)=>{gt(t,o,e)});return t}(e),u=new Set,f=new Set,g=new Map,m=new Map;let b,w,y,k,C,M,P,x,S,A;for(w=n.firstChild;w;){if(b=w.cgKey,dt(w))if(y=r.get(b),C=c.get(b),M=a.get(b),k=w.cgPiece,!w.cgDragging||l&&l.orig===b||(w.classList.remove("dragging"),h(w,o(i(b),t)),w.cgDragging=!1),!M&&w.cgFading&&(w.cgFading=!1,w.classList.remove("fading")),y){if(C&&w.cgAnimating&&k===ft(y)){const e=i(b);e[0]+=C[2],e[1]+=C[3],w.classList.add("anim"),h(w,o(e,t))}else w.cgAnimating&&(w.cgAnimating=!1,w.classList.remove("anim"),h(w,o(i(b),t)),e.addPieceZIndex&&(w.style.zIndex=ht(i(b),t)));k!==ft(y)||M&&w.cgFading?M&&k===ft(M)?(w.classList.add("fading"),w.cgFading=!0):mt(g,k,w):u.add(b)}else mt(g,k,w);else if(ut(w)){const e=w.className;d.get(b)===e?f.add(b):mt(m,e,w)}w=w.nextSibling}for(const[e,r]of d)if(!f.has(e)){S=m.get(r),A=S&&S.pop();const s=o(i(e),t);if(A)A.cgKey=e,h(A,s);else{const t=v("square",r);t.cgKey=e,h(t,s),n.insertBefore(t,n.firstChild)}}for(const[s,a]of r)if(C=c.get(s),!u.has(s))if(P=g.get(ft(a)),x=P&&P.pop(),x){x.cgKey=s,x.cgFading&&(x.classList.remove("fading"),x.cgFading=!1);const n=i(s);e.addPieceZIndex&&(x.style.zIndex=ht(n,t)),C&&(x.cgAnimating=!0,x.classList.add("anim"),n[0]+=C[2],n[1]+=C[3]),h(x,o(n,t))}else{const r=ft(a),c=v("piece",r),l=i(s);c.cgPiece=r,c.cgKey=s,C&&(c.cgAnimating=!0,l[0]+=C[2],l[1]+=C[3]),h(c,o(l,t)),e.addPieceZIndex&&(c.style.zIndex=ht(l,t)),n.appendChild(c)}for(const t of g.values())pt(e,t);for(const t of m.values())pt(e,t)}function lt(e){const t=e.dom.elements.wrap.getBoundingClientRect(),o=e.dom.elements.container,n=t.height/t.width,r=8*Math.floor(t.width*window.devicePixelRatio/8)/window.devicePixelRatio,s=r*n;o.style.width=r+"px",o.style.height=s+"px",e.dom.bounds.clear(),e.addDimensionsCssVarsTo?.style.setProperty("---cg-width",r+"px"),e.addDimensionsCssVarsTo?.style.setProperty("---cg-height",s+"px")}const dt=e=>"PIECE"===e.tagName,ut=e=>"SQUARE"===e.tagName;function pt(e,t){for(const o of t)e.dom.elements.board.removeChild(o)}function ht(e,t){const o=e[1];return`${t?10-o:3+o}`}const ft=e=>`${e.color} ${e.role}`;function gt(e,t,o){const n=e.get(t);n?e.set(t,`${n} ${o}`):e.set(t,o)}function mt(e,t,o){const n=e.get(t);n?n.push(o):e.set(t,[o])}function bt(e,t){!function(e,t,o){const n=new Map,r=[];for(const t of e)n.set(t.hash,!1);let s,i=t.firstElementChild;for(;i;)s=i.getAttribute("cgHash"),n.has(s)?n.set(s,!0):r.push(i),i=i.nextElementSibling;for(const e of r)t.removeChild(e);for(const r of e)n.get(r.hash)||t.appendChild(o(r))}(e.drawable.autoShapes.filter(e=>e.piece).map(e=>({shape:e,hash:vt(e),current:!1})),t,t=>function(e,{shape:t,hash:o},n){const r=t.orig,s=t.piece?.role,c=t.piece?.color,a=t.piece?.scale,l=v("piece",`${s} ${c}`);return l.setAttribute("cgHash",o),l.cgKey=r,l.cgScale=a,f(l,p(n)(i(r),ae(e)),a),l}(e,t,e.dom.bounds()))}const vt=e=>[e.orig,e.piece?.role,e.piece?.color,e.piece?.scale].join(",");function wt(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}return function(n,r){const s={pieces:pe(le),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,touchIgnoreRadius:1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10},paleWhite:{key:"pwhite",color:"white",opacity:.6,lineWidth:10}},prevSvgHash:""},hold:a()};function c(){const r="dom"in s?s.dom.unbind:void 0,c=function(n,r){n.innerHTML="",n.classList.add("cg-wrap");for(const t of e)n.classList.toggle("orientation-"+t,r.orientation===t);n.classList.toggle("manipulable",!r.viewOnly);const s=v("cg-container");n.appendChild(s);const i=v("cg-board");let c,a,l,d,u,p;if(s.appendChild(i),r.drawable.visible&&([c,a]=["cg-shapes-below","cg-shapes"].map(e=>nt(e,!0)),[l,d]=["cg-custom-below","cg-custom-svgs"].map(e=>nt(e,!1)),u=v("cg-auto-pieces"),s.appendChild(c),s.appendChild(l),s.appendChild(a),s.appendChild(d),s.appendChild(u)),r.coordinates){const e="black"===r.orientation?" black":"",n="left"===r.ranksPosition?" left":"";if(r.coordinatesOnSquares){const i="white"===r.orientation?e=>e+1:e=>8-e;t.forEach((t,r)=>s.appendChild(rt(o.map(e=>t+e),"squares rank"+i(r)+e+n)))}else s.appendChild(rt(o,"ranks"+e+n)),s.appendChild(rt(t,"files"+e))}return r.draggable.enabled&&r.draggable.showGhost&&(p=v("piece","ghost"),g(p,!1),s.appendChild(p)),{board:i,container:s,wrap:n,ghost:p,shapes:a,shapesBelow:c,custom:d,customBelow:l,autoPieces:u}}(n,s),a=function(e){let t;const o=()=>(void 0===t&&(t=e()),t);return o.clear=()=>{t=void 0},o}(()=>c.board.getBoundingClientRect()),l=e=>{at(u),c.autoPieces&&bt(u,c.autoPieces),!e&&c.shapes&&Be(u,c)},d=()=>{lt(u),function(e){const t=ae(e),o=p(e.dom.bounds());let n=e.dom.elements.board.firstChild;for(;n;)(dt(n)&&!n.cgAnimating||ut(n))&&h(n,o(i(n.cgKey),t)),n=n.nextSibling}(u),c.autoPieces&&function(e){const t=ae(e),o=p(e.dom.bounds());let n=e.dom.elements.autoPieces?.firstChild;for(;n;)f(n,o(i(n.cgKey),t),n.cgScale),n=n.nextSibling}(u)},u=s;return u.dom={elements:c,bounds:a,redraw:wt(l),redrawNow:l,unbind:r},u.drawable.prevSvgHash="",lt(u),l(!1),function(e,t){const o=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&o.addEventListener("contextmenu",e=>e.preventDefault()),e.viewOnly)return;const n=it(e);o.addEventListener("touchstart",n,{passive:!1}),o.addEventListener("mousedown",n,{passive:!1})}(u,d),r||(u.dom.unbind=function(e,t){const o=[];if("ResizeObserver"in window||o.push(st(document.body,"chessground.resize",t)),!e.viewOnly){const t=ct(e,Ee,Se),n=ct(e,De,Ae);for(const e of["touchmove","mousemove"])o.push(st(document,e,t));for(const e of["touchend","mouseup"])o.push(st(document,e,n));const r=()=>e.dom.bounds.clear();o.push(st(document,"scroll",r,{capture:!0,passive:!0})),o.push(st(window,"resize",r,{passive:!0}))}return()=>o.forEach(e=>e())}(u,d)),u.events.insert&&u.events.insert(c),u}return fe(s,r||{}),Ne(c(),c)}});
//# sourceMappingURL=chessground.umd.js.map
